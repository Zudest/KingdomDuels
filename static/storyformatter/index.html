<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kingdom Duels Story Formatter</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f7f7f7;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .panel {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .input-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
    }
    
    input[type="file"] {
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .preview-container {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
    }
    
    .preview-table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 30px;
    }
    
    .preview-table:last-child {
      margin-bottom: 0;
    }
    
    .preview-table th {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 12px 8px;
    }
    
    .preview-table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    
    .player-setup { background-color: #FF9800; color: white; } /* Orange */
    .player-1 { background-color: #F44336; color: white; } /* Red */
    .player-2 { background-color: #2196F3; color: white; } /* Blue */
    .player-3 { background-color: #4CAF50; color: white; } /* Green */
    .player-4 { background-color: #FFEB3B; color: white; } /* Yellow */
    .player-5 { background-color: #E91E63; color: white; } /* Pink */
    .player-6 { background-color: #9C27B0; color: white; } /* Purple */
    
    .shortcode-output {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      white-space: pre-wrap;
      font-family: monospace;
      height: 300px;
      overflow-y: auto;
      font-size: 14px;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    
    .error {
      color: #d9534f;
      font-weight: bold;
      margin-top: 5px;
    }
    
    .success {
      color: #4CAF50;
      font-weight: bold;
      margin-top: 5px;
    }
    
    .duel-header {
      background-color: #2c3e50;
      color: white;
      padding: 10px 15px;
      margin: 20px 0 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .duel-header:first-child {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Kingdom Duels Story Formatter</h1>
  
  <div class="container">
    <!-- Input Section -->
    <div class="panel">
      <div class="input-container">
        <label for="csv-file">Upload CSV File:</label>
        <input type="file" id="csv-file" accept=".csv" />
        <div id="file-info"></div>
      </div>
    </div>
    
    <!-- Preview Section -->
    <div class="panel">
      <h3>Preview</h3>
      <div class="preview-container">
        <div id="table-preview">
          <p>Upload a CSV file to see the preview</p>
        </div>
      </div>
    </div>
    
    <!-- Output Section -->
    <div class="panel">
      <h3>Hugo Shortcode Output</h3>
      <div class="shortcode-output" id="shortcode-output">
        Upload a CSV file to generate Hugo shortcode
      </div>
      <div class="actions">
        <button id="copy-shortcode-btn" disabled>Copy Shortcode</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // DOM elements
    const csvFileInput = document.getElementById('csv-file');
    const fileInfoDiv = document.getElementById('file-info');
    const tablePreview = document.getElementById('table-preview');
    const shortcodeOutput = document.getElementById('shortcode-output');
    const copyShortcodeBtn = document.getElementById('copy-shortcode-btn');
    
    // Store parsed data
    let duels = [];
    let fileName = "";
    
    // Default column headers
    const DEFAULT_COLUMN_HEADERS = ["Player", "Action", "LP", "Notes"];
    
    // Default column widths (fixed in the shortcode: 12%, 51%, 12%, 25%)
    const COLUMN_WIDTHS = [12, 51, 12, 25];
    
    // Default column alignments (fixed in the shortcode: center, left, center, left)
    const COLUMN_ALIGNS = ["center", "left", "center", "left"];
    
    // Event listeners
    csvFileInput.addEventListener('change', handleFileUpload);
    copyShortcodeBtn.addEventListener('click', () => copyToClipboard(shortcodeOutput.textContent));
    
    // Handle file upload
    function handleFileUpload(event) {
      const file = event.target.files[0];
      
      if (!file) {
        return;
      }
      
      fileName = file.name.replace('.csv', '');
      fileInfoDiv.textContent = `File: ${file.name} (${formatFileSize(file.size)})`;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvContent = e.target.result;
        processCSV(csvContent);
      };
      reader.readAsText(file);
    }
    
    // Process CSV with multiple duels support
    function processCSV(csvContent) {
      try {
        const rawParse = Papa.parse(csvContent, {
          header: false,
          skipEmptyLines: true,
          delimiter: '',
          delimitersToGuess: [',', ';', '\t', '|']
        });
        
        if (rawParse.errors.length > 0 && rawParse.errors[0].code !== "UndetectableDelimiter") {
          fileInfoDiv.innerHTML = `<span class="error">Error parsing CSV: ${rawParse.errors[0].message}</span>`;
          return;
        }
        
        const rawData = rawParse.data;
        if (rawData.length === 0) {
          fileInfoDiv.innerHTML = `<span class="error">No data found in CSV file</span>`;
          return;
        }
        
        // Parse multiple duels
        duels = parseMultipleDuels(rawData);
        
        if (duels.length === 0) {
          fileInfoDiv.innerHTML = `<span class="error">No duels found in CSV file</span>`;
          return;
        }
        
        // Generate outputs
        generateOutputs();
        copyShortcodeBtn.disabled = false;
        
        fileInfoDiv.innerHTML = fileInfoDiv.textContent + ` <span class="success">âœ“ Successfully parsed (${duels.length} duel${duels.length > 1 ? 's' : ''})</span>`;
      } catch (error) {
        console.error("CSV Processing Error:", error);
        fileInfoDiv.innerHTML = `<span class="error">Error processing CSV: ${error.message}</span>`;
      }
    }
    
    // Parse multiple duels from raw data
    function parseMultipleDuels(rawData) {
      const parsedDuels = [];
      let currentDuel = null;
      
      for (let i = 0; i < rawData.length; i++) {
        const row = rawData[i];
        
        // Check if this row starts a new duel (begins with "EP ")
        if (row[0] && row[0].toString().trim().toUpperCase().startsWith('EP ')) {
          // Save previous duel if it exists
          if (currentDuel) {
            parsedDuels.push(currentDuel);
          }
          
          // Start new duel
          currentDuel = {
            header: row,
            data: []
          };
        } else if (currentDuel && row.length > 0) {
          // Add data row to current duel
          currentDuel.data.push(row);
        }
      }
      
      // Don't forget the last duel
      if (currentDuel) {
        parsedDuels.push(currentDuel);
      }
      
      return parsedDuels;
    }
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // Get player type based on name
    function getPlayerType(player) {
      if (!player) return '';
      
      const playerLower = String(player).toLowerCase().trim();
      
      if (playerLower.includes('setup')) return 'player-setup';
      if (playerLower.includes('player 1') || playerLower.includes('player1')) return 'player-1';
      if (playerLower.includes('player 2') || playerLower.includes('player2')) return 'player-2';
      if (playerLower.includes('player 3') || playerLower.includes('player3')) return 'player-3';
      if (playerLower.includes('player 4') || playerLower.includes('player4')) return 'player-4';
      if (playerLower.includes('player 5') || playerLower.includes('player5')) return 'player-5';
      if (playerLower.includes('player 6') || playerLower.includes('player6')) return 'player-6';
      
      return '';
    }
    
    // Generate all outputs
    function generateOutputs() {
      if (!duels || duels.length === 0) {
        return;
      }
      
      // Build the HTML table for preview
      generateTablePreview();
      
      // Generate the shortcode output
      const shortcode = generateFullShortcode();
      shortcodeOutput.textContent = shortcode;
    }
    
    // Generate Hugo shortcode with multiple duels
    function generateFullShortcode() {
      let output = '';
      
      duels.forEach((duel, index) => {
        if (index > 0) {
          output += '\n\n';
        }
        
        // Add the prefix for each duel
        if (duel.header && duel.header[0] && duel.header[1]) {
          output += `---\n## ${duel.header[0]} - ${duel.header[1]}\n\n`;
        }
        
        // Create the shortcode with fixed headers
        output += `{{< dueltable header1="Player" header2="Action" header3="LP" header4="Notes"`;
        
        // Add data rows
        if (duel.data.length > 0) {
          let firstRow = [...duel.data[0]];
          while (firstRow.length < 4) {
            firstRow.push("");
          }
          output += ` >}}${firstRow.join('|')}`;
          
          // Add remaining rows
          for (let i = 1; i < duel.data.length; i++) {
            let paddedRow = [...duel.data[i]];
            while (paddedRow.length < 4) {
              paddedRow.push("");
            }
            output += `\n${paddedRow.join('|')}`;
          }
        } else {
          output += ` >}}`;
        }
        
        // Close the shortcode
        output += `\n{{< /dueltable >}}`;
      });
      
      return output;
    }
    
    // Generate HTML table preview for all duels
    function generateTablePreview() {
      let previewHTML = '';
      
      duels.forEach((duel, duelIndex) => {
        // Add duel header
        if (duel.header && duel.header[0] && duel.header[1]) {
          previewHTML += `<div class="duel-header">${duel.header[0]} - ${duel.header[1]}</div>`;
        }
        
        // Generate table for this duel
        let tableHTML = '<table class="preview-table">';
        
        // Generate header row
        tableHTML += '<thead><tr>';
        for (let i = 0; i < 4; i++) {
          tableHTML += `<th style="width: ${COLUMN_WIDTHS[i]}%">${DEFAULT_COLUMN_HEADERS[i]}</th>`;
        }
        tableHTML += '</tr></thead>';
        
        // Generate data rows
        tableHTML += '<tbody>';
        duel.data.forEach(row => {
          tableHTML += '<tr>';
          
          for (let colIndex = 0; colIndex < 4; colIndex++) {
            const cellValue = colIndex < row.length ? row[colIndex] : '';
            
            if (colIndex === 0) { // Player column
              const playerType = getPlayerType(cellValue);
              tableHTML += `<td class="${playerType}" style="text-align: ${COLUMN_ALIGNS[colIndex]}">${cellValue}</td>`;
            } else {
              tableHTML += `<td style="text-align: ${COLUMN_ALIGNS[colIndex]}">${cellValue}</td>`;
            }
          }
          
          tableHTML += '</tr>';
        });
        
        tableHTML += '</tbody></table>';
        previewHTML += tableHTML;
      });
      
      tablePreview.innerHTML = previewHTML;
    }
    
    // Copy to clipboard function
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(
        function() {
          const originalText = copyShortcodeBtn.textContent;
          copyShortcodeBtn.textContent = 'Copied!';
          setTimeout(() => {
            copyShortcodeBtn.textContent = originalText;
          }, 2000);
        }
      ).catch(
        function() {
          alert('Failed to copy text. Please try selecting and copying manually.');
        }
      );
    }
  </script>
</body>
</html>
